name: Cleanup Google Cloud (GKE)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "DELETE" to confirm cluster deletion'
        required: true
        default: ''

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  GKE_CLUSTER: sorrento-cluster
  GKE_ZONE: europe-west1-b
  IMAGE: sorrentomarina
  USE_GKE_GCLOUD_AUTH_PLUGIN: True

jobs:
  cleanup:
    name: Cleanup GKE Resources
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'DELETE'
    
    steps:
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Setup Google Cloud CLI
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}

    - name: Install GKE auth plugin
      run: |-
        echo "Installing GKE auth plugin..."
        sudo apt-get update
        sudo apt-get install -y google-cloud-sdk-gke-gcloud-auth-plugin || echo "Plugin may already be available"
        export USE_GKE_GCLOUD_AUTH_PLUGIN=True

    - name: Cleanup all GCP resources
      env:
        USE_GKE_GCLOUD_AUTH_PLUGIN: True
      run: |
        echo "🗑️ Starting GCP cleanup process..."
        
        # Delete Kubernetes namespace first
        if gcloud container clusters describe $GKE_CLUSTER --zone $GKE_ZONE >/dev/null 2>&1; then
          echo "📋 Getting cluster credentials and deleting namespace..."
          gcloud container clusters get-credentials $GKE_CLUSTER --zone $GKE_ZONE
          kubectl delete namespace sorrentomarina --ignore-not-found=true || true
          
          echo "🔥 Deleting GKE cluster..."
          gcloud container clusters delete $GKE_CLUSTER --zone $GKE_ZONE --quiet
          echo "✅ GKE cluster deleted"
        else
          echo "ℹ️  GKE cluster doesn't exist"
        fi
        
        # Delete Artifact Registry images
        echo "🐳 Cleaning up Artifact Registry images..."
        gcloud artifacts docker images list europe-west1-docker.pkg.dev/$PROJECT_ID/sorrentomarina/$IMAGE --include-tags --limit=999 --format="get(version)" | \
        xargs -I {} gcloud artifacts docker images delete "europe-west1-docker.pkg.dev/$PROJECT_ID/sorrentomarina/$IMAGE:{}" --quiet || true
        echo "✅ Container images cleaned up"
        
        echo ""
        echo "🎉 Cleanup completed successfully!"
        echo "💰 All GCP resources have been removed to avoid charges"
        echo "📊 Final status: No GKE cluster or container images remaining"